# HLKX 移植ギャップ監査 (2026-02-27)

## 目的
コンテキストが流れても移植漏れを再発させないため、未移植・未検証項目を固定化する。

## 結論サマリ
- 現在の `Rhlk` は「一部実案件で一致する最小互換」には到達している。
- ただし、HLKX 全ロジックの完全移植としては未完。
- 特に `make_exe.s` の命令実行系（opaque/write-stack/expression）と、`main.s` のCLI/運用機能に未移植が残る。

## 主要ギャップ

### 1. 命令実行系 (`make_exe.s`) の未移植/部分移植
- `Opaque` 実体化は部分対応で、全命令群を値解決できていない。
  - 現状: `40/41/42/43/46/50/51/52/53/56` を主に実体化
  - 未完カテゴリ例: `45/47/55/57/65/69/6a/6b/92/96/9a` のフル意味再現
- `4c01/4d01` は最小実装済み。
  - `___CTOR_LIST__/___DTOR_LIST__` シンボル位置へ `[-1, entries..., 0]` table をパッチ。
  - ただし HLK の g2lk モード連携（`CTOR_LIST_PTR/DTOR_LIST_PTR` 計算や `.doctor/.dodtor` 条件分岐）までは未再現。
- `.ctor/.dtor` 利用時に `.doctor/.dodtor` が欠落している場合は明示エラー化済み。
- `.doctor/.dodtor` (`e00c/e00d`) と `c00c/c00d` は現状 no-op として受理する（厳密互換は未完）。
- `c00c/c00d` がある場合、header size と実際の `4c01/4d01` 件数 (`count*4`) の整合を検証。
- 式評価 `a0xx` は一部サブコードで簡略化が残る（例: `a002` の専用動作）。
- `wrt_stk_92/96/9a` 系は underflow を含む分岐が未検証/未実装だった（本ドキュメント作成時点）。

### 2. 入力解決パイプライン (`object.s` 相当)
- 元HLKの `obj/arc/lib` 取り込みは未完（部分対応）。
- Rust側は `Request (e001)` の最小解決を実装済み（同ディレクトリ + カレント探索で追加読み込み）。
- `Request` 名に拡張子がない場合は `.o/.obj` も探索。
- `.a/.lib` は ar 形式の単純メンバー展開を実装済み（全メンバー取り込み）。
- GNU long filename table (`//`, `/NNN`) は最小対応済み。
- archive member は未解決シンボルを満たすもののみ選択する最小ロジックを実装済み。
- 最終リンク前に未解決 `xref` を検出してエラー化するチェックを実装済み。
- 再走査（新たに増えた未解決参照で先頭から再探索）を実装・テスト済み。
- 同名定義が複数ある場合の先頭優先をテストで固定済み。
- 入力列で同一 archive を複数回指定した際の再訪を許可（`lib.a obj.o lib.a` で後段解決可能）。
- request 経由の同一 archive 再訪も許可（訪問上限でループ保護）。
- 未完: HLK互換の抽出優先順位（同名定義が複数ある場合など）の厳密一致。
- 未完: アーカイブ/ライブラリ形式の解決とHLK互換探索順。

### 3. CLI互換 (`main.s`) の未移植
- 現在のCLIは `-o/-a/-an/-r/--rn/--makemcs/--omit-bss/-p/-v/-x/--version` 中心。
- 出力名の既定導出と拡張子補完を最小互換で実装済み（`-a/-an/-r/--makemcs` 反映）。
- 元HLKで実装済みの広範なオプションは未移植:
  - 例: `-a/-an/-b/-d/-e/-g/-i/-l/-L/-p/-s/-t/-w/-x/-0/-1/--version` など

### 4. SCD補正ロジック
- `make_scdinfo` 相当は段階移植中で、コード内コメントの通り「reduced fixup」が残る。

### 5. map生成 (`make_map.s`)
- `-p[FILE]` の最小 map 出力を実装済み（シンボル名/セクション/アドレス）。
- `-p` の既定名導出（入力/出力名から `.map`）と `-pfoo` の拡張子補完をテストで固定済み。
- `make_map` 形式に寄せ、`EXEC` 行・section範囲行・`xdef` 見出しの出力を追加。
- `xref/xdef/comm/rcomm/rlcomm` 見出しブロックを追加（最小内容）。
- `xdef/comm` 行を `name : addr (sect)` 形式へ寄せ、`xref` に `in <object>` を出力。
- 未完: HLK `make_map.s` 相当の詳細フォーマット一致。

## テスト監査 (2026-02-27 時点)

### 既存で担保済み
- 既存 `external/hlkx/tests` ベース回帰 (`tools/run_hlkx_regression.sh`)
- 生成物比較 (`.x/.r/.mcs`) とメッセージ比較（stdout/stderr結合）
- `writer.rs` のユニットテスト群:
  - relocation
  - xref絶対値処理
  - SCD補正主要分岐
  - `--rn`/start address/odd relocation等のエラー
 - `linker.rs` のユニットテスト:
  - `Request` で要求されたオブジェクトを同ディレクトリから追加ロード

### 追加が必要だった/必要な領域
- `wrt_stk_92/96/9a` の underflow 分岐
- `a0` サブコードの網羅（特に `a002` 含む）
- `Opaque` 命令群の「実体化可否」と「再配置判定」の網羅的テスト
- arc/lib/request フローの回帰
- CLI 互換オプションの振る舞いテスト

## 実装・検証方針
1. まず命令実行系の差分を先に潰す（バイナリ一致に直結するため）。
2. テスト先行で、HLK分岐単位のケースを追加する。
3. 回帰ハーネス + Rust unit test の両輪で固定化する。
4. CLI/arc/lib/map は別フェーズで機能単位に導入する。

## 次アクション（この後着手）
- `a002`, `9200`, `9600`, `9a00` の不足分を
  1) 先にテスト追加
  2) 実装
  3) `cargo test` + 回帰ハーネス確認

## 本ターンで実施済み
- 追加テスト（unit）
  - `a002_only_requires_stack_value`
  - `wrt_stk_9100_reports_underflow`
  - `wrt_stk_9200_reports_underflow`
  - `wrt_stk_9300_reports_underflow`
  - `wrt_stk_9600_reports_underflow`
  - `wrt_stk_9900_reports_underflow`
  - `wrt_stk_9a00_reports_underflow`
  - `materializes_45ff_word_from_xref`
  - `materializes_47ff_with_global_xref_value`
  - `materializes_55ff_word_with_offset`
  - `materializes_57ff_byte_with_offset`
  - `materializes_6501_word_displacement`
  - `materializes_6901_word_displacement_alias`
  - `materializes_6a01_long_displacement`
  - `materializes_6b01_byte_displacement`
  - `materializes_9000_from_calc_stack_value`
  - `materializes_9100_from_calc_stack_value`
  - `materializes_9200_from_calc_stack_value`
  - `materializes_9300_from_calc_stack_value`
  - `materializes_9900_from_calc_stack_value`
- 追加テスト（run68回帰）
  - `stack_under_9200`
  - `stack_under_9600`
  - `stack_under_9a00`
- 実装
  - `classify_expression_errors` に `0x92/0x96/0x9a` の underflow 判定追加
  - `evaluate_a0` に `0x02` の専用挙動追加
  - `Opaque` 実体化を拡張し、`45/47/55/57/65/69/6a/6b` と
    `lo=01..0a` のセクション配置反映を追加
  - `patch_opaque` に最小の calc stack 実行を導入し、
    `8000` から `9000/9200/9300/9100/9600/9900/9a00` への値出力を追加
- 検証結果
  - `cargo test` 全件成功
  - `tools/run_hlkx_regression.sh` 全ケース一致
